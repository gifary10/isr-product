<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manajemen Aplikasi</title>
  <!-- Load from CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Custom CSS -->
  <style>
    :root {
      --primary-color: #4e73df;
      --secondary-color: #858796;
      --success-color: #1cc88a;
      --warning-color: #f6c23e;
      --danger-color: #e74a3b;
    }
    
    body {
      background-color: #f8f9fc;
      padding-bottom: 80px;
    }
    
    .navbar-brand {
      font-weight: 700;
    }
    
    .card {
      border-radius: 0.5rem;
      box-shadow: 0 0.15rem 0.5rem rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      border: none;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.15);
    }
    
    .status-badge {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.35em 0.65em;
    }
    
    .floating-btn {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      width: 3.5rem;
      height: 3.5rem;
      z-index: 100;
      box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
    }
    
    .search-container {
      background-color: white;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0.15rem 0.5rem rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem 0;
    }
    
    .empty-state-icon {
      font-size: 4rem;
      opacity: 0.3;
      margin-bottom: 1rem;
    }
    
    .category-badge {
      background-color: #f0f0f0;
      color: #555;
      font-size: 0.7rem;
    }
    
    /* Responsive adjustments */
    @media (max-width: 576px) {
      .card {
        margin-bottom: 1rem;
      }
      .search-container {
        padding: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="fas fa-mobile-alt me-2"></i>Manajemen Aplikasi
      </a>
      <button class="btn btn-sm btn-light ms-auto d-lg-none" id="mobileAddBtn">
        <i class="fas fa-plus"></i>
      </button>
    </div>
  </nav>

  <div class="container">
    <!-- Search and Filter -->
    <div class="search-container sticky-top">
      <div class="row g-2">
        <div class="col-md-6">
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" id="searchInput" class="form-control" placeholder="Cari aplikasi...">
            <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <div class="col-md-4">
          <select id="filterCategory" class="form-select">
            <option value="">Semua Kategori</option>
          </select>
        </div>
        <div class="col-md-2 d-none d-lg-block">
          <button class="btn btn-primary w-100" id="addBtn">
            <i class="fas fa-plus me-1"></i> Tambah
          </button>
        </div>
      </div>
    </div>

    <!-- Data Container -->
    <div id="dataContainer" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      <!-- Data akan dimuat di sini -->
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state d-none animate__animated animate__fadeIn">
      <div class="empty-state-icon">
        <i class="fas fa-box-open"></i>
      </div>
      <h4 class="text-muted mb-3">Tidak ada data ditemukan</h4>
      <p class="text-muted mb-4">Coba gunakan kata kunci lain atau tambahkan data baru</p>
      <button class="btn btn-primary" id="emptyAddBtn">
        <i class="fas fa-plus me-2"></i>Tambah Aplikasi
      </button>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Memuat...</span>
      </div>
      <p class="mt-2 text-muted">Memuat data...</p>
    </div>
  </div>

  <!-- Floating Add Button (Mobile) -->
  <button id="mobileFloatingBtn" class="btn btn-primary rounded-circle floating-btn d-lg-none animate__animated animate__bounceIn">
    <i class="fas fa-plus"></i>
  </button>

  <!-- Modals -->
  <div class="modal fade" id="dataModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Tambah Aplikasi</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="dataForm" novalidate>
            <input type="hidden" id="dataId">
            <div class="mb-3">
              <label for="kategori" class="form-label">Kategori <span class="text-danger">*</span></label>
              <select class="form-select" id="kategori" required>
                <option value="">Pilih Kategori</option>
              </select>
              <div class="invalid-feedback">Harap pilih kategori</div>
            </div>
            <div class="mb-3">
              <label for="nama" class="form-label">Nama Aplikasi <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="nama" required>
              <div class="invalid-feedback">Harap isi nama aplikasi</div>
            </div>
            <div class="mb-3">
              <label for="deskripsi" class="form-label">Deskripsi <span class="text-danger">*</span></label>
              <textarea class="form-control" id="deskripsi" rows="3" required></textarea>
              <div class="invalid-feedback">Harap isi deskripsi</div>
            </div>
            <div class="mb-3">
              <label for="status" class="form-label">Status <span class="text-danger">*</span></label>
              <select class="form-select" id="status" required>
                <option value="">Pilih Status</option>
              </select>
              <div class="invalid-feedback">Harap pilih status</div>
            </div>
            <div class="mb-3">
              <label for="link" class="form-label">Link</label>
              <input type="url" class="form-control" id="link" placeholder="https://example.com">
              <div class="form-text">Opsional</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-primary" id="saveBtn">
            <span class="spinner-border spinner-border-sm d-none" id="saveSpinner" role="status" aria-hidden="true"></span>
            <span id="saveText">Simpan</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Konfirmasi Hapus</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Anda yakin ingin menghapus aplikasi ini? Tindakan ini tidak dapat dibatalkan.</p>
          <p class="text-danger fw-bold" id="deleteItemName"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
            <span class="spinner-border spinner-border-sm d-none" id="deleteSpinner" role="status" aria-hidden="true"></span>
            <span id="deleteText">Ya, Hapus</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="toast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastMessage"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Inisialisasi komponen
    const dataModal = new bootstrap.Modal('#dataModal');
    const deleteModal = new bootstrap.Modal('#deleteModal');
    const toast = new bootstrap.Toast('#toast');
    
    // Variabel global
    let currentData = [];
    let deleteId = null;
    let deleteName = '';

    // Event saat DOM siap
    document.addEventListener('DOMContentLoaded', function() {
      initApp();
    });

    // Fungsi inisialisasi aplikasi
    function initApp() {
      loadCategories();
      loadStatuses();
      setupEventListeners();
      loadData();
    }

    // Muat data dari Google Sheets
    function loadData() {
      showLoading(true);
      
      google.script.run
        .withSuccessHandler(data => {
          currentData = data;
          renderData(data);
          showLoading(false);
        })
        .withFailureHandler(error => {
          showToast('Gagal memuat data: ' + error.message, 'danger');
          showLoading(false);
        })
        .getData();
    }

    // Render data ke tampilan
    function renderData(data) {
      const container = document.getElementById('dataContainer');
      container.innerHTML = '';
      
      if (data.length === 0) {
        document.getElementById('emptyState').classList.remove('d-none');
        return;
      } else {
        document.getElementById('emptyState').classList.add('d-none');
      }
      
      data.forEach(item => {
        const card = createCardElement(item);
        container.appendChild(card);
      });
      
      // Tambahkan event listener setelah render
      setupCardEventListeners();
    }

    // Buat elemen card untuk setiap item
    function createCardElement(item) {
      const card = document.createElement('div');
      card.className = 'col animate__animated animate__fadeIn';
      card.innerHTML = `
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h5 class="card-title mb-0">${item.nama}</h5>
              <span class="badge category-badge">${item.kategori}</span>
            </div>
            <div class="mb-3">
              <span class="badge status-badge ${getStatusClass(item.status)}">${item.status}</span>
            </div>
            <p class="card-text text-muted">${item.deskripsi || 'Tidak ada deskripsi'}</p>
          </div>
          <div class="card-footer bg-transparent border-top-0">
            <div class="d-flex justify-content-between align-items-center">
              ${item.link ? `
                <a href="${item.link}" target="_blank" class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-external-link-alt me-1"></i> Buka
                </a>
              ` : '<span class="text-muted small">Tidak ada link</span>'}
              <div>
                <button class="btn btn-sm btn-outline-secondary me-1 edit-btn" data-id="${item.no}">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${item.no}" data-name="${item.nama}">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      return card;
    }

    // Dapatkan class CSS berdasarkan status
    function getStatusClass(status) {
      switch(status) {
        case 'Beli': return 'bg-success';
        case 'Coming Soon': return 'bg-warning text-dark';
        case 'Dalam Pengembangan': return 'bg-info text-dark';
        case 'Gratis': return 'bg-primary';
        case 'Trial': return 'bg-secondary';
        default: return 'bg-light text-dark';
      }
    }

    // Muat kategori dari GS
    function loadCategories() {
      google.script.run
        .withSuccessHandler(categories => {
          const filterSelect = document.getElementById('filterCategory');
          const formSelect = document.getElementById('kategori');
          
          categories.forEach(category => {
            filterSelect.add(new Option(category, category));
            formSelect.add(new Option(category, category));
          });
        })
        .getCategories();
    }

    // Muat status dari GS
    function loadStatuses() {
      google.script.run
        .withSuccessHandler(statuses => {
          const select = document.getElementById('status');
          statuses.forEach(status => {
            select.add(new Option(status, status));
          });
        })
        .getStatuses();
    }

    // Setup event listeners
    function setupEventListeners() {
      // Tombol tambah
      document.getElementById('addBtn').addEventListener('click', showAddForm);
      document.getElementById('mobileFloatingBtn').addEventListener('click', showAddForm);
      document.getElementById('mobileAddBtn').addEventListener('click', showAddForm);
      document.getElementById('emptyAddBtn').addEventListener('click', showAddForm);
      
      // Pencarian
      document.getElementById('searchInput').addEventListener('input', filterData);
      document.getElementById('clearSearchBtn').addEventListener('click', () => {
        document.getElementById('searchInput').value = '';
        filterData();
      });
      document.getElementById('filterCategory').addEventListener('change', filterData);
      
      // Form
      document.getElementById('saveBtn').addEventListener('click', saveData);
      document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
      
      // Validasi form
      document.getElementById('dataForm').addEventListener('submit', e => e.preventDefault());
    }

    // Setup event listeners untuk card
    function setupCardEventListeners() {
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          editData(id);
        });
      });
      
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          deleteId = btn.getAttribute('data-id');
          deleteName = btn.getAttribute('data-name');
          showDeleteModal();
        });
      });
    }

    // Tampilkan form tambah
    function showAddForm() {
      document.getElementById('modalTitle').textContent = 'Tambah Aplikasi';
      document.getElementById('dataForm').reset();
      document.getElementById('dataId').value = '';
      dataModal.show();
    }

    // Edit data
    function editData(id) {
      const item = currentData.find(item => item.no === id);
      if (item) {
        document.getElementById('modalTitle').textContent = 'Edit Aplikasi';
        document.getElementById('dataId').value = item.no;
        document.getElementById('kategori').value = item.kategori;
        document.getElementById('nama').value = item.nama;
        document.getElementById('deskripsi').value = item.deskripsi;
        document.getElementById('status').value = item.status;
        document.getElementById('link').value = item.link || '';
        dataModal.show();
      }
    }

    // Tampilkan modal hapus
    function showDeleteModal() {
      document.getElementById('deleteItemName').textContent = deleteName;
      deleteModal.show();
    }

    // Filter data
    function filterData() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const category = document.getElementById('filterCategory').value;
      
      const filtered = currentData.filter(item => {
        const matchesSearch = item.nama.toLowerCase().includes(searchTerm) || 
                           (item.deskripsi && item.deskripsi.toLowerCase().includes(searchTerm));
        const matchesCategory = category ? item.kategori === category : true;
        return matchesSearch && matchesCategory;
      });
      
      renderData(filtered);
    }

    // Simpan data
    function saveData() {
      const form = document.getElementById('dataForm');
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }
      
      const saveBtn = document.getElementById('saveBtn');
      const spinner = document.getElementById('saveSpinner');
      const saveText = document.getElementById('saveText');
      
      // Tampilkan loading
      saveBtn.disabled = true;
      spinner.classList.remove('d-none');
      saveText.textContent = 'Menyimpan...';
      
      const data = {
        no: document.getElementById('dataId').value,
        kategori: document.getElementById('kategori').value,
        nama: document.getElementById('nama').value,
        deskripsi: document.getElementById('deskripsi').value,
        status: document.getElementById('status').value,
        link: document.getElementById('link').value
      };
      
      const isEdit = !!data.no;
      
      const handler = isEdit 
        ? google.script.run.updateData(data)
        : google.script.run.addData(data);
      
      handler
        .withSuccessHandler(() => {
          showToast(`Data berhasil ${isEdit ? 'diperbarui' : 'ditambahkan'}!`, 'success');
          dataModal.hide();
          loadData();
        })
        .withFailureHandler(error => {
          showToast(`Gagal menyimpan: ${error.message}`, 'danger');
        })
        .finally(() => {
          saveBtn.disabled = false;
          spinner.classList.add('d-none');
          saveText.textContent = 'Simpan';
        });
    }

    // Konfirmasi hapus
    function confirmDelete() {
      const deleteBtn = document.getElementById('confirmDeleteBtn');
      const spinner = document.getElementById('deleteSpinner');
      const deleteText = document.getElementById('deleteText');
      
      // Tampilkan loading
      deleteBtn.disabled = true;
      spinner.classList.remove('d-none');
      deleteText.textContent = 'Menghapus...';
      
      google.script.run
        .withSuccessHandler(() => {
          showToast('Data berhasil dihapus!', 'success');
          deleteModal.hide();
          loadData();
        })
        .withFailureHandler(error => {
          showToast(`Gagal menghapus: ${error.message}`, 'danger');
        })
        .finally(() => {
          deleteBtn.disabled = false;
          spinner.classList.add('d-none');
          deleteText.textContent = 'Ya, Hapus';
        })
        .deleteData(deleteId);
    }

    // Tampilkan loading
    function showLoading(show) {
      document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
    }

    // Tampilkan toast notifikasi
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      
      toast.className = `toast align-items-center text-white bg-${type} border-0`;
      toastMessage.textContent = message;
      
      const bsToast = bootstrap.Toast.getOrCreateInstance(toast);
      bsToast.show();
    }
  </script>
</body>
</html>
